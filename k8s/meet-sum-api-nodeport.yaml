apiVersion: v1
kind: ConfigMap
metadata:
  name: meet-sum-api-config
data:
  # Synced from project .env
  TYPHOON_BASE_URL: "https://api.opentyphoon.ai/v1"
  TYPHOON_MODEL: "typhoon-v2.5-30b-a3b-instruct"
  TYPHOON_MAX_TOKENS: "8192"

  ALLOW_CHAT_FALLBACK: "true"
  ALLOW_OLLAMA_CHAT_FALLBACK: "true"
  CHAT_FALLBACK_PROVIDER: "ollama"
  EMBEDDING_PROVIDER: "ollama"

  OLLAMA_BASE_URL: "http://172.20.12.7:31319"
  OLLAMA_CHAT_MODEL: "scb10x/typhoon2.5-qwen3-30b-a3b:latest"
  OLLAMA_MODEL: "scb10x/typhoon2.5-qwen3-30b-a3b:latest"
  OLLAMA_EMBED_MODEL: "qwen3-embedding:0.6b"

  VLLM_BASE_URL: "http://172.20.12.7:30801"
  VLLM_API_KEY: "EMPTY"
  VLLM_CHAT_MODEL: "Qwen/Qwen3.5-35B-A3B-FP8"
  VLLM_EMBED_MODEL: "qwen3-embedding:0.6b"

  SUMMARIZE_MODE: "agenda"
  INCLUDE_OCR: "true"
  IMAGE_INSERT_ENABLED: "true"
  SAVE_INTERMEDIATE: "true"
  PIPELINE_MAX_CONCURRENCY: "1"

  AGENT1_CHUNK_SIZE: "40"
  AGENT1_CHUNK_OVERLAP: "1"
  AGENT1_SUBCHUNK_ON_FAILURE: "true"
  AGENT1_SUBCHUNK_SIZE: "10"
  AGENT1_OCR_MAX_CAPTURES: "2"
  AGENT1_OCR_SNIPPET_CHARS: "160"
  AGENT2_CHUNK_SIZE: "60"
  AGENT25_CHUNK_SIZE: "12"

  TRANSCRIPT_PATH: "./data/transcript_2025-01-04.json"
  CONFIG_PATH: "./data/config_2025-01-04.json"
  OCR_PATH: "./data/video_change_ocr/run_20260213_163003/capture_ocr_results.json"
  OUTPUT_HTML_PATH: "./output/meeting_report.html"

  # API options

  API_LOG_LEVEL: "INFO"
  API_CORS_ALLOW_ORIGINS: "*"
  API_CORS_ALLOW_METHODS: "*"
  API_CORS_ALLOW_HEADERS: "*"
  API_CORS_ALLOW_CREDENTIALS: "false"
  API_MAX_REQUEST_BODY_BYTES: "5242880"
  API_MAX_SEGMENTS: "10000"
  API_MAX_FULL_TEXT_CHARS: "1500000"
  API_MAX_MEETING_INFO_CHARS: "200000"
  API_MAX_AGENDA_TEXT_CHARS: "500000"
  API_MAX_TOPIC_TIME_OVERRIDES: "2000"
  API_MAX_CAPTURES: "30000"
  API_WORKER_JOIN_TIMEOUT_SEC: "10"
  API_PROCESS_TERMINATE_GRACE_SEC: "5"
---
apiVersion: v1
kind: Secret
metadata:
  name: meet-sum-api-secret
type: Opaque
stringData:
  # Keep empty to force fallback-only mode (no Typhoon calls).
  TYPHOON_API_KEY: ""
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: meet-sum-api
  labels:
    app: meet-sum-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: meet-sum-api
  template:
    metadata:
      labels:
        app: meet-sum-api
    spec:
      terminationGracePeriodSeconds: 30
      containers:
      - name: meet-sum-api
        image: l3ankky/meet-sum-api:0.21
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 8000
        envFrom:
        - configMapRef:
            name: meet-sum-api-config
        - secretRef:
            name: meet-sum-api-secret
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 20
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        # resources:
        #   requests:
        #     cpu: "250m"
        #     memory: "512Mi"
        #   limits:
        #     cpu: "1000m"
        #     memory: "2Gi"
        volumeMounts:
        - name: output
          mountPath: /app/output
      volumes:
      - name: output
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: meet-sum-api
  labels:
    app: meet-sum-api
spec:
  type: NodePort
  selector:
    app: meet-sum-api
  ports:
  - name: http
    protocol: TCP
    port: 8000
    targetPort: 8000
    nodePort: 30080
